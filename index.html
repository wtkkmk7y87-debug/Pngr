<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>åœ°å›³ãƒ†ã‚¹ãƒˆ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
}
#map {
  width: 100%;
  height: 100%;
}
button {
  position: fixed;
  left: 10px;
  top: 10px;
  z-index: 1000;
  padding: 6px 10px;
}
</style>
</head>

<body>

<button id="btn-gps">ğŸ“ ç¾åœ¨åœ°å–å¾—</button>
<div id="map"></div>

<script>
// ===== ç”»åƒã‚µã‚¤ã‚º =====
const imageWidth  = 3312;
const imageHeight = 3392;

// ===== åœ°å›³ =====
const bounds = [[0, 0], [imageHeight, imageWidth]];
const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -2,
  maxZoom: 2
});
L.imageOverlay('map.png', bounds).addTo(map);
map.fitBounds(bounds);

// ===== ãƒãƒ¼ã‚«ãƒ¼ =====
let startMarker = null;
let goalMarker  = null;
let routeLine   = null;

// ===== ä»®ï¼šGPS â†’ ç”»åƒåº§æ¨™å¤‰æ› =====
// â€» ä»Šã¯ã€Œåœ°å›³ä¸­å¤®ã«å‡ºã™ã€ã ã‘
function gpsToImage(lat, lng) {
  return {
    x: imageWidth  / 2,
    y: imageHeight / 2
  };
}

// ===== ãƒ«ãƒ¼ãƒˆæç”» =====
function drawRoute() {
  if (!startMarker || !goalMarker) return;

  if (routeLine) map.removeLayer(routeLine);

  routeLine = L.polyline([
    startMarker.getLatLng(),
    goalMarker.getLatLng()
  ], {
    color: 'blue',
    weight: 4
  }).addTo(map);
}

// ===== GPSç¾åœ¨åœ°å–å¾— =====
document.getElementById("btn-gps").onclick = () => {
  if (!navigator.geolocation) {
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯GPSã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    const p = gpsToImage(lat, lng);

    if (startMarker) map.removeLayer(startMarker);

    startMarker = L.marker([p.y, p.x])
      .addTo(map)
      .bindPopup("ç¾åœ¨åœ°ï¼ˆGPSï¼‰")
      .openPopup();

    drawRoute();
  }, () => {
    alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
  });
};

// ===== ç›®çš„åœ°ï¼šåœ°å›³ã‚¿ãƒƒãƒ— =====
map.on("click", e => {
  if (goalMarker) map.removeLayer(goalMarker);

  goalMarker = L.marker(e.latlng)
    .addTo(map)
    .bindPopup("ç›®çš„åœ°")
    .openPopup();

  drawRoute();
});
</script>

</body>
</html>
