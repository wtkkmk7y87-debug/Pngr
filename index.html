<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ã‚ªãƒªã‚¸ãƒŠãƒ«åœ°å›³ãƒŠãƒ“</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
Â  body { margin:0; }
Â  #map { height:100vh; }
Â  button {
Â  Â  position: fixed;
Â  Â  top: 10px;
Â  Â  left: 10px;
Â  Â  z-index: 999;
Â  Â  padding: 10px;
Â  }
</style>
</head>

<body>
<button onclick="setGoal()">ğŸ¯ç›®çš„åœ°ã‚’ç½®ã</button>
<button onclick="getLocation()">ğŸ“ç¾åœ¨åœ°</button>
<div id="map"></div>

<script>
const imageWidth = 3312;
const imageHeight = 3392;
const bounds = [[0,0], [imageHeight, imageWidth]];

// â˜…åŸºæº–ç‚¹Aï¼ˆæ›¸ãæ›ãˆã‚‹ï¼‰
const pointA = {
Â  lat: 35.639524,
Â  lng: 139.300163,
Â  x: 2938,
Â  y: 1700
};

// â˜…åŸºæº–ç‚¹Bï¼ˆæ›¸ãæ›ãˆã‚‹ï¼‰
const pointB = {
Â  lat: 35.638538,
Â  lng: 139.299397,
Â  x: 2545,
Â  y: 2306
};

const map = L.map('map', {
Â  crs: L.CRS.Simple,
Â  minZoom: -2
});

L.imageOverlay('map.png', bounds).addTo(map);
map.fitBounds(bounds);

let myMarker, goalMarker, routeLine;

// GPS â†’ ç”»åƒåº§æ¨™ã¸å¤‰æ›
function gpsToImage(lat, lng) {
Â  const dx = (pointB.x - pointA.x) / (pointB.lng - pointA.lng);
Â  const dy = (pointB.y - pointA.y) / (pointB.lat - pointA.lat);

Â  const x = pointA.x + (lng - pointA.lng) * dx;
Â  const y = pointA.y + (lat - pointA.lat) * dy;

Â  return [y, x];
}

// ç¾åœ¨åœ°
function getLocation() {
Â  navigator.geolocation.getCurrentPosition(pos => {
Â  Â  const p = gpsToImage(pos.coords.latitude, pos.coords.longitude);

Â  Â  if(myMarker) map.removeLayer(myMarker);
Â  Â  myMarker = L.marker(p).addTo(map).bindPopup("ç¾åœ¨åœ°").openPopup();

Â  Â  drawRoute();
Â  });
}

// ç›®çš„åœ°è¨­ç½®ï¼ˆã‚¿ãƒƒãƒ—ï¼‰
function setGoal() {
Â  alert("åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç›®çš„åœ°ã‚’æ±ºã‚ã¦ãã ã•ã„");
Â  map.once("click", e => {
Â  Â  if(goalMarker) map.removeLayer(goalMarker);
Â  Â  goalMarker = L.marker(e.latlng).addTo(map).bindPopup("ç›®çš„åœ°").openPopup();
Â  Â  drawRoute();
Â  });
}

// ãƒ«ãƒ¼ãƒˆæç”»ï¼ˆç›´ç·šï¼‰
function drawRoute() {
Â  if(!myMarker || !goalMarker) return;

Â  if(routeLine) map.removeLayer(routeLine);

Â  routeLine = L.polyline([
Â  Â  myMarker.getLatLng(),
Â  Â  goalMarker.getLatLng()
Â  ]).addTo(map);
}
</script>
</body>
</html>